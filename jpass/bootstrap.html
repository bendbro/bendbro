<!DOCTYPE html>
<html>
	<head><title>Dropbox password manager</title></head>
	<body></body>
</html>

<script>
    /* mutation observer example
	document.body.onload = function() {
		var div = document.createElement("div");
		div.setAttribute("contenteditable", true);
		div.innerHTML = "Ayyyyyy";
		var body = document.getElementsByTagName("body")[0];
		body.appendChild(div);
		
		var observer = new MutationObserver(function(mutations) {
			mutations.forEach(function(mutation) {
				alert("Recording mutation: " + mutation.target.textContent);
			});
		});

		observer.observe(div, {
			attributes: false,
			childList: false, // child element modification
			characterData: true, // current value of data
			characterDataOldValue: false, // previous value of data
			subtree: true // inner elements
		});
	};*/

	// Populator is a function. A function is an object. You can call a function.
	function type(object) {
		return Object.prototype.toString.call(object);
	}
	
	function PrimitiveObjectModel(targetProperty, containingObject) {
		this.targetProperty = targetProperty;
		this.containingObject = containingObject;
		this.saved = true;
		
		this.getData = function() {
			return this.containingObject[targetProperty]
		};
		
		this.setData = function(data) {
			if(data != this.containingObject[this.targetProperty]) {
				this.saved = false;
			}
			this.containingObject[targetProperty] = data;
		};
		
		this.innerData = function() {
			return {};
		};
	}
	
	function JsObjectModel(bind) {
		this.bind = bind;
		this.models = {};

		this.applyData = function(update) {
			for(property in update) {
				var pprop = property;
				var object = update[pprop];
				if(this.models[pprop] != null) {
					this.models[pprop].setData(object);
				} else {
					var model = null;
					switch(type(object)) {
						case "[object Object]":
							model = new JsObjectModel(object);
							break;
						case "[object Array]":
							model = new JsObjectModel(object);
							break;
						case "[object String]":
							model = new PrimitiveObjectModel(pprop,update);
							break;
						case "[object Number]":
							model = new PrimitiveObjectModel(pprop,update);
							break;
						default:
							model = new PrimitiveObjectModel(pprop,update);
					}
					this.bind[pprop] = object;
					this.models[pprop] = model;
				}
			}
		};
		
		this.applyData(bind);
		
		this.getData = function() {
			return this.bind;
		};
		
		this.setData = function(update) {
			this.applyData(update);
		};
		
		this.innerData = function() {
			return this.models;
		};
	}
	
	function ItemView(html, model) {
		this.html = html;
		this.model = model;
		
		this.html.innerHTML = model.getData();
		this.html.setAttribute("contenteditable", true);
		var model = this.model;
		this.observer = new MutationObserver(function(mutations) {
			mutations.forEach(function(mutation) {
				model.setData(mutation.target.textContent);
			});
		});
		this.observer.observe(this.html, {
			attributes: false,
			childList: false, // child element modification
			characterData: true, // current value of data
			characterDataOldValue: false, // previous value of data
			subtree: true // inner elements
		});
	}
	
	function RowView(row, model) {
		this.row = row;
		this.model = model;
		this.views = {};
		
		this.update = function(model) {
			var innerData = model.innerData();
			for(rowViewProperty in innerData) {
				if(this.views[rowViewProperty] == null) {
					var rowElement = document.createElement("td");
					var nameDiv = document.createElement("div");
					nameDiv.innerHTML = rowViewProperty;
					var valueDiv = document.createElement("div");
					rowElement.appendChild(nameDiv);
					rowElement.appendChild(valueDiv);
					this.row.appendChild(rowElement);
					this.views[rowViewProperty] = new ItemView(valueDiv, innerData[rowViewProperty]);
				}
			}
		};
		
		this.update(this.model);
	}
	
	function TableView(table, model) {
		this.table = table;
		this.model = model;
		this.views = {};
		
		this.update = function(model) {
			var innerData = model.innerData();
			for(tableViewProperty in innerData) {
				if(this.views[tableViewProperty] == null) {
					var row = document.createElement("tr");
					table.appendChild(row);
					this.views[tableViewProperty] = new RowView(row, innerData[tableViewProperty]);
				}
				this.views[tableViewProperty].update(innerData[tableViewProperty]);
			}
		};
		
		this.update(this.model);
	}

	document.body.onload = function() {
		var data = [
		 {username:"a", password:"b"},
		 {username:"a", password:"b"}
		];
		var model = new JsObjectModel(data);
	
		var div = document.createElement("div");
		div.setAttribute("class", "container");
		var table = document.createElement("table");
		table.setAttribute("class", "table table-striped");
		var header = document.createElement("h2");
		header.innerHTML = "passwords yo";
		div.appendChild(header);
		div.appendChild(table);
		document.body.appendChild(div);
		
		var view = new TableView(table, model);
		
		var submit = document.createElement("button");
		submit.innerHTML = "submit";
		submit.onclick = function() {
			for(entryIndex in model.innerData()){
				var entry = model.innerData()[entryIndex];
				var saved = true;
				for(property in entry.innerData()) {
					if(entry.innerData()[property].saved == false) {
						saved = false;
						entry.innerData()[property].saved = true;
					}
				}
				if(saved == false) {
					alert(JSON.stringify(data[entryIndex]));
				}
			}
		};
		div.appendChild(submit);
		
		var newdata = document.createElement("button");
		newdata.innerHTML = "new";
		newdata.onclick = function() {
			data.push({username:"u", password:"p"});
			model.applyData(data);
			view.update(model);
		};
		div.appendChild(newdata);
	};
</script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
